name: Update Homebrew Tap

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish to tap (for example: v0.1.1)"
        required: true

permissions:
  contents: read

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve release tag
        id: vars
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi

          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Expected semver tag like v0.1.0, got: $TAG"
            exit 1
          fi

          VERSION="${TAG#v}"
          SRC_URL="https://github.com/bhagyas/authbear/archive/refs/tags/${TAG}.tar.gz"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "src_url=$SRC_URL" >> "$GITHUB_OUTPUT"

      - name: Download source tarball and compute checksum
        id: sha
        run: |
          set -euo pipefail
          curl -fL "${{ steps.vars.outputs.src_url }}" -o source.tar.gz
          SHA=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Clone tap repository
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${TAP_GITHUB_TOKEN:-}" ]; then
            echo "Missing TAP_GITHUB_TOKEN secret."
            echo "Create a classic PAT with repo scope and add it to this repo secrets as TAP_GITHUB_TOKEN."
            exit 1
          fi

          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/bhagyas/homebrew-authbear.git" tap

      - name: Update formula
        run: |
          set -euo pipefail
          FORMULA="tap/Formula/authbear.rb"

          sed -i "s|^  url .*|  url \"${{ steps.vars.outputs.src_url }}\"|" "$FORMULA"
          sed -i "s|^  sha256 .*|  sha256 \"${{ steps.sha.outputs.sha }}\"|" "$FORMULA"

      - name: Commit and push formula update
        working-directory: tap
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No formula changes detected."
            exit 0
          fi

          git add Formula/authbear.rb
          git commit -m "authbear ${{ steps.vars.outputs.tag }}"
          git push origin main
